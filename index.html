<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UniTracker ‚Äî Not & Devamsƒ±zlƒ±k Takibi</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #F6F1EB;
  --card: #FFFFFF;
  --primary: #2D5A3D;
  --primary-light: #3A7A52;
  --primary-pale: #E8F0EB;
  --accent: #D4A24E;
  --accent-light: #F5E6C8;
  --danger: #C0392B;
  --danger-light: #FADBD8;
  --warning: #E67E22;
  --warning-light: #FDEBD0;
  --success: #27AE60;
  --success-light: #D5F5E3;
  --text: #2C3E2D;
  --text-light: #6B7C6E;
  --border: #D5CFC7;
  --shadow: 0 2px 12px rgba(45, 90, 61, 0.08);
  --shadow-lg: 0 8px 32px rgba(45, 90, 61, 0.12);
  --radius: 14px;
  --radius-sm: 8px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  line-height: 1.6;
}

/* ===== HEADER ===== */
.header {
  background: linear-gradient(135deg, var(--primary) 0%, #1B3D28 100%);
  padding: 28px 0 24px;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 4px 20px rgba(27, 61, 40, 0.25);
}

.header-inner {
  max-width: 960px;
  margin: 0 auto;
  padding: 0 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.logo {
  display: flex;
  align-items: center;
  gap: 14px;
}

.logo-icon {
  width: 44px;
  height: 44px;
  background: var(--accent);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  box-shadow: 0 2px 8px rgba(212, 162, 78, 0.4);
}

.logo h1 {
  font-family: 'DM Serif Display', serif;
  font-size: 26px;
  color: #fff;
  font-weight: 400;
  letter-spacing: 0.5px;
}

.logo h1 span {
  color: var(--accent);
}

/* ===== NAVIGATION TABS ===== */
.nav-tabs {
  display: flex;
  gap: 6px;
  background: rgba(255,255,255,0.1);
  padding: 4px;
  border-radius: 12px;
}

.nav-tab {
  padding: 10px 22px;
  border: none;
  background: transparent;
  color: rgba(255,255,255,0.7);
  font-family: 'DM Sans', sans-serif;
  font-size: 14px;
  font-weight: 600;
  border-radius: 9px;
  cursor: pointer;
  transition: all 0.25s ease;
  display: flex;
  align-items: center;
  gap: 8px;
}

.nav-tab:hover {
  color: #fff;
  background: rgba(255,255,255,0.1);
}

.nav-tab.active {
  background: #fff;
  color: var(--primary);
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.nav-tab svg { width: 18px; height: 18px; }

/* ===== MAIN CONTENT ===== */
.main {
  max-width: 960px;
  margin: 0 auto;
  padding: 32px 24px 80px;
}

.page { display: none; }
.page.active { display: block; animation: fadeUp 0.35s ease; }

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ===== CARDS ===== */
.card {
  background: var(--card);
  border-radius: var(--radius);
  padding: 28px;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  margin-bottom: 24px;
  transition: box-shadow 0.2s ease;
}

.card:hover { box-shadow: var(--shadow-lg); }

.card-title {
  font-family: 'DM Serif Display', serif;
  font-size: 22px;
  color: var(--primary);
  margin-bottom: 6px;
}

.card-subtitle {
  font-size: 14px;
  color: var(--text-light);
  margin-bottom: 24px;
}

/* ===== FORM ELEMENTS ===== */
label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-light);
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

input[type="text"],
input[type="number"],
input[type="email"],
select {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid var(--border);
  border-radius: var(--radius-sm);
  font-family: 'DM Sans', sans-serif;
  font-size: 15px;
  color: var(--text);
  background: #FAFAF8;
  transition: border-color 0.2s, box-shadow 0.2s;
  outline: none;
}

input:focus, select:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px var(--primary-pale);
  background: #fff;
}

.form-row {
  display: grid;
  gap: 16px;
  margin-bottom: 18px;
}

.form-row-2 { grid-template-columns: 1fr 1fr; }
.form-row-3 { grid-template-columns: 1fr 1fr 1fr; }
.form-row-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }
.form-row-6 { grid-template-columns: repeat(6, 1fr); }

.form-group { display: flex; flex-direction: column; }

/* ===== BUTTONS ===== */
.btn {
  padding: 12px 28px;
  border: none;
  border-radius: var(--radius-sm);
  font-family: 'DM Sans', sans-serif;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.btn-primary {
  background: var(--primary);
  color: #fff;
}
.btn-primary:hover { background: var(--primary-light); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(45, 90, 61, 0.3); }

.btn-accent {
  background: var(--accent);
  color: #fff;
}
.btn-accent:hover { background: #C4922E; }

.btn-outline {
  background: transparent;
  color: var(--primary);
  border: 2px solid var(--primary);
}
.btn-outline:hover { background: var(--primary-pale); }

.btn-danger {
  background: var(--danger);
  color: #fff;
}
.btn-danger:hover { background: #A93226; }

.btn-sm {
  padding: 8px 16px;
  font-size: 13px;
}

.btn-icon {
  width: 36px;
  height: 36px;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  border: none;
  background: transparent;
  cursor: pointer;
  color: var(--text-light);
  transition: all 0.2s;
}

.btn-icon:hover { background: #f0ebe4; color: var(--danger); }

/* ===== GRADE CALCULATOR PAGE ===== */
.result-box {
  background: linear-gradient(135deg, var(--primary-pale) 0%, #D8EDE0 100%);
  border-radius: var(--radius);
  padding: 28px;
  text-align: center;
  border: 2px solid var(--primary);
  margin-top: 24px;
  animation: fadeUp 0.4s ease;
}

.result-box.danger {
  background: linear-gradient(135deg, var(--danger-light) 0%, #F9E0DC 100%);
  border-color: var(--danger);
}

.result-box.warning {
  background: linear-gradient(135deg, var(--warning-light) 0%, #FEF0DB 100%);
  border-color: var(--warning);
}

.result-label {
  font-size: 14px;
  color: var(--text-light);
  text-transform: uppercase;
  letter-spacing: 1px;
  font-weight: 600;
  margin-bottom: 4px;
}

.result-value {
  font-family: 'DM Serif Display', serif;
  font-size: 52px;
  color: var(--primary);
  line-height: 1.1;
}

.result-box.danger .result-value { color: var(--danger); }
.result-box.warning .result-value { color: var(--warning); }

.result-note {
  font-size: 14px;
  color: var(--text-light);
  margin-top: 8px;
}

/* ===== ATTENDANCE PAGE ===== */
.course-card {
  background: var(--card);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  overflow: hidden;
  margin-bottom: 20px;
  box-shadow: var(--shadow);
  transition: box-shadow 0.2s;
}

.course-card:hover { box-shadow: var(--shadow-lg); }

.course-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px 24px;
  cursor: pointer;
  user-select: none;
  transition: background 0.2s;
}

.course-header:hover { background: #FAFAF8; }

.course-info h3 {
  font-family: 'DM Serif Display', serif;
  font-size: 19px;
  color: var(--primary);
}

.course-info p {
  font-size: 13px;
  color: var(--text-light);
  margin-top: 2px;
}

.course-stats {
  display: flex;
  gap: 16px;
  align-items: center;
}

.stat-badge {
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 600;
}

.stat-badge.ok { background: var(--success-light); color: var(--success); }
.stat-badge.warn { background: var(--warning-light); color: var(--warning); }
.stat-badge.danger { background: var(--danger-light); color: var(--danger); }

.progress-ring {
  width: 48px;
  height: 48px;
  position: relative;
}

.progress-ring svg {
  transform: rotate(-90deg);
  width: 48px;
  height: 48px;
}

.progress-ring .bg { stroke: #E8E4DD; }
.progress-ring .fill { transition: stroke-dashoffset 0.5s ease; }
.progress-ring .label {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 11px;
  font-weight: 700;
}

.course-body {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.35s ease;
}

.course-body.open { max-height: 2000px; }

.course-body-inner { padding: 0 24px 24px; }

.week-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
  gap: 8px;
  margin-top: 12px;
}

.week-btn {
  aspect-ratio: 1;
  border: 2px solid var(--border);
  border-radius: 10px;
  background: #FAFAF8;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 2px;
  transition: all 0.2s;
  font-family: 'DM Sans', sans-serif;
}

.week-btn span:first-child {
  font-size: 11px;
  color: var(--text-light);
  font-weight: 600;
}

.week-btn span:last-child {
  font-size: 18px;
}

.week-btn.present {
  background: var(--success-light);
  border-color: var(--success);
  color: var(--success);
}

.week-btn.absent {
  background: var(--danger-light);
  border-color: var(--danger);
  color: var(--danger);
}

.week-btn:hover { transform: scale(1.05); }

.chevron {
  transition: transform 0.3s ease;
  color: var(--text-light);
}

.chevron.open { transform: rotate(180deg); }

/* ===== ADD COURSE MODAL ===== */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(44, 62, 45, 0.4);
  backdrop-filter: blur(4px);
  z-index: 200;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.2s ease;
}

.modal-overlay.active { display: flex; }

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal {
  background: var(--card);
  border-radius: var(--radius);
  padding: 32px;
  width: 90%;
  max-width: 520px;
  box-shadow: var(--shadow-lg);
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from { transform: translateY(20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.modal-title {
  font-family: 'DM Serif Display', serif;
  font-size: 22px;
  color: var(--primary);
  margin-bottom: 20px;
}

.modal-actions {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  margin-top: 24px;
}

/* ===== CALENDAR EXPORT ===== */
.export-section {
  margin-top: 16px;
  padding: 20px;
  background: var(--accent-light);
  border-radius: var(--radius-sm);
  border: 1px solid var(--accent);
}

.export-section p {
  font-size: 14px;
  color: var(--text);
  margin-bottom: 12px;
}

/* ===== SUMMARY DASHBOARD ===== */
.summary-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  margin-bottom: 24px;
}

.summary-card {
  background: var(--card);
  border-radius: var(--radius);
  padding: 22px;
  text-align: center;
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
}

.summary-card .number {
  font-family: 'DM Serif Display', serif;
  font-size: 36px;
  color: var(--primary);
}

.summary-card .label {
  font-size: 12px;
  color: var(--text-light);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 600;
  margin-top: 4px;
}

/* ===== EMPTY STATE ===== */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-light);
}

.empty-state svg {
  width: 80px;
  height: 80px;
  color: var(--border);
  margin-bottom: 16px;
}

.empty-state h3 {
  font-family: 'DM Serif Display', serif;
  font-size: 20px;
  color: var(--text);
  margin-bottom: 8px;
}

/* ===== TOAST ===== */
.toast {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: var(--primary);
  color: #fff;
  padding: 14px 28px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 600;
  box-shadow: 0 8px 24px rgba(45, 90, 61, 0.3);
  z-index: 999;
  transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
  white-space: nowrap;
}

.toast.show { transform: translateX(-50%) translateY(0); }

/* ===== RESPONSIVE ===== */
@media (max-width: 700px) {
  .header-inner { flex-direction: column; gap: 14px; }
  .nav-tabs { width: 100%; }
  .nav-tab { flex: 1; justify-content: center; padding: 10px 14px; font-size: 13px; }
  .form-row-2, .form-row-3, .form-row-4, .form-row-6 { grid-template-columns: 1fr; }
  #midterm-inputs .form-row { grid-template-columns: 1fr 1fr !important; }
  .summary-grid { grid-template-columns: 1fr; }
  .course-header { flex-direction: column; align-items: flex-start; gap: 12px; }
  .course-stats { width: 100%; justify-content: space-between; }
  .week-grid { grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); }
  .result-value { font-size: 40px; }
}
</style>
</head>
<body>

<!-- HEADER -->
<header class="header">
  <div class="header-inner">
    <div class="logo">
      <div class="logo-icon">üéì</div>
      <h1>Uni<span>Tracker</span></h1>
    </div>
    <nav class="nav-tabs">
      <button class="nav-tab active" onclick="switchPage('grade')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>
        Not Hesapla
      </button>
      <button class="nav-tab" onclick="switchPage('attendance')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        Devamsƒ±zlƒ±k
      </button>
    </nav>
  </div>
</header>

<!-- MAIN -->
<main class="main">

  <!-- ======== GRADE CALCULATOR PAGE ======== -->
  <div id="page-grade" class="page active">
    <div class="card">
      <h2 class="card-title">Not Hesaplayƒ±cƒ±</h2>
      <p class="card-subtitle">Vize notlarƒ±nƒ± gir, finalden ka√ß alman gerektiƒüini hesaplayalƒ±m.</p>

      <div class="form-row form-row-4">
        <div class="form-group">
          <label>Ders Adƒ±</label>
          <input type="text" id="g-course-name" placeholder="√ñrn: Yapay Zeka">
        </div>
        <div class="form-group">
          <label>Ka√ß Vize Var?</label>
          <select id="g-midterm-count" onchange="buildMidtermInputs()">
            <option value="1">1 Vize</option>
            <option value="2" selected>2 Vize</option>
            <option value="3">3 Vize</option>
          </select>
        </div>
        <div class="form-group">
          <label>Ge√ßme Notu</label>
          <input type="number" id="g-pass-grade" value="50" min="0" max="100">
        </div>
        <div class="form-group">
          <label>Final Min. Not</label>
          <input type="number" id="g-final-min" value="0" min="0" max="100" placeholder="√ñrn: 40">
        </div>
      </div>

      <div id="midterm-inputs"></div>

      <div class="form-row form-row-2" style="margin-top:4px;">
        <div class="form-group">
          <label>Final Y√ºzdesi (%)</label>
          <input type="number" id="g-final-pct" value="60" min="0" max="100">
        </div>
        <div class="form-group" style="display:flex;align-items:flex-end;">
          <button class="btn btn-primary" style="width:100%" onclick="calculateGrade()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
            Hesapla
          </button>
        </div>
      </div>

      <div id="grade-result"></div>
    </div>

    <!-- SAVED CALCULATIONS -->
    <div class="card" id="saved-calcs-card" style="display:none;">
      <h2 class="card-title">Kayƒ±tlƒ± Hesaplamalar</h2>
      <p class="card-subtitle">√ñnceki hesaplamalarƒ±nƒ± buradan g√∂rebilirsin.</p>
      <div id="saved-calcs-list"></div>
    </div>
  </div>

  <!-- ======== ATTENDANCE PAGE ======== -->
  <div id="page-attendance" class="page">

    <div class="summary-grid" id="att-summary">
      <div class="summary-card">
        <div class="number" id="sum-total">0</div>
        <div class="label">Toplam Ders</div>
      </div>
      <div class="summary-card">
        <div class="number" id="sum-absent">0</div>
        <div class="label">Toplam Devamsƒ±zlƒ±k</div>
      </div>
      <div class="summary-card">
        <div class="number" id="sum-risk">0</div>
        <div class="label">Riskli Ders</div>
      </div>
    </div>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h2 style="font-family:'DM Serif Display',serif; font-size:24px; color:var(--primary);">Derslerim</h2>
      <button class="btn btn-primary" onclick="openAddCourseModal()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Ders Ekle
      </button>
    </div>

    <div id="courses-list"></div>

    <!-- Calendar Export -->
    <div class="card" style="margin-top: 12px;">
      <h2 class="card-title">üìÖ Takvim Hatƒ±rlatƒ±cƒ±sƒ±</h2>
      <p class="card-subtitle">Derslerini Google Calendar'a ekleyerek her hafta ders saatinde hatƒ±rlatma al.</p>
      <div class="export-section">
        <p>Her dersin yanƒ±ndaki üìÖ ikonuna tƒ±klayarak o dersi tek tek takvime ekleyebilirsin. Ya da a≈üaƒüƒ±daki butonla t√ºm dersleri tek bir .ics dosyasƒ±nda indir.</p>
        <div id="calendar-course-list"></div>
        <button class="btn btn-accent" onclick="exportAllCoursesICS()" style="margin-top:12px;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          T√ºm Dersleri Takvime Ekle (.ics)
        </button>
      </div>
    </div>
  </div>

</main>

<!-- ADD COURSE MODAL -->
<div class="modal-overlay" id="modal-add-course">
  <div class="modal">
    <h3 class="modal-title">Yeni Ders Ekle</h3>
    <div class="form-row">
      <div class="form-group">
        <label>Ders Adƒ±</label>
        <input type="text" id="m-course-name" placeholder="√ñrn: Veri Yapƒ±larƒ±">
      </div>
    </div>
    <div class="form-row form-row-2">
      <div class="form-group">
        <label>Toplam Hafta</label>
        <input type="number" id="m-total-weeks" value="14" min="1" max="30">
      </div>
      <div class="form-group">
        <label>Max Devamsƒ±zlƒ±k Hakkƒ±</label>
        <input type="number" id="m-max-absent" value="3" min="1" max="20">
      </div>
    </div>
    <div class="form-row form-row-3">
      <div class="form-group">
        <label>Ders G√ºn√º</label>
        <select id="m-course-day">
          <option value="MO">Pazartesi</option>
          <option value="TU">Salƒ±</option>
          <option value="WE">√áar≈üamba</option>
          <option value="TH">Per≈üembe</option>
          <option value="FR">Cuma</option>
          <option value="SA">Cumartesi</option>
          <option value="SU">Pazar</option>
        </select>
      </div>
      <div class="form-group">
        <label>Ders Saati</label>
        <select id="m-course-hour">
          <option value="08:00">08:00</option>
          <option value="08:30">08:30</option>
          <option value="09:00">09:00</option>
          <option value="09:30">09:30</option>
          <option value="10:00">10:00</option>
          <option value="10:30">10:30</option>
          <option value="11:00">11:00</option>
          <option value="11:30">11:30</option>
          <option value="12:00">12:00</option>
          <option value="12:30">12:30</option>
          <option value="13:00">13:00</option>
          <option value="13:30">13:30</option>
          <option value="14:00">14:00</option>
          <option value="14:30">14:30</option>
          <option value="15:00">15:00</option>
          <option value="15:30">15:30</option>
          <option value="16:00">16:00</option>
          <option value="16:30">16:30</option>
          <option value="17:00">17:00</option>
          <option value="17:30">17:30</option>
          <option value="18:00">18:00</option>
          <option value="18:30">18:30</option>
          <option value="19:00">19:00</option>
          <option value="19:30">19:30</option>
          <option value="20:00">20:00</option>
        </select>
      </div>
      <div class="form-group">
        <label>Ders S√ºresi</label>
        <select id="m-course-duration">
          <option value="0.5">30 dk</option>
          <option value="1">1 saat</option>
          <option value="1.5">1 saat 30 dk</option>
          <option value="2" selected>2 saat</option>
          <option value="2.5">2 saat 30 dk</option>
          <option value="3">3 saat</option>
          <option value="3.5">3 saat 30 dk</option>
          <option value="4">4 saat</option>
        </select>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeAddCourseModal()">ƒ∞ptal</button>
      <button class="btn btn-primary" onclick="addCourse()">Ders Ekle</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ============================
// DATA LAYER (localStorage)
// ============================
const STORAGE_KEYS = {
  courses: 'unitracker_courses',
  calcs: 'unitracker_calcs'
};

function loadData(key) {
  try {
    return JSON.parse(localStorage.getItem(key)) || [];
  } catch { return []; }
}

function saveData(key, data) {
  localStorage.setItem(key, JSON.stringify(data));
}

// ============================
// NAVIGATION
// ============================
function switchPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  document.querySelectorAll('.nav-tab')[page === 'grade' ? 0 : 1].classList.add('active');
}

// ============================
// TOAST NOTIFICATION
// ============================
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2800);
}

// ============================
// GRADE CALCULATOR
// ============================
function buildMidtermInputs() {
  const count = parseInt(document.getElementById('g-midterm-count').value);
  const container = document.getElementById('midterm-inputs');
  const finalPct = parseInt(document.getElementById('g-final-pct').value) || 60;
  const totalMidtermPct = 100 - finalPct;
  const eachPct = Math.round(totalMidtermPct / count);

  let html = '<div class="form-row" style="display:grid;grid-template-columns:repeat(' + Math.min(count * 2, 6) + ', 1fr);align-items:end;">';
  for (let i = 0; i < count; i++) {
    html += `
      <div class="form-group">
        <label>Vize ${i + 1} Notu</label>
        <input type="number" id="g-mid-${i}" placeholder="0-100" min="0" max="100">
      </div>
      <div class="form-group">
        <label>Vize ${i + 1} Y√ºzdesi (%)</label>
        <input type="number" id="g-mid-pct-${i}" value="${i === count - 1 ? totalMidtermPct - eachPct * (count - 1) : eachPct}" min="0" max="100">
      </div>`;
  }
  html += '</div>';

  container.innerHTML = html;
}

// Rebuild midterm inputs when final percentage changes
document.getElementById('g-final-pct').addEventListener('input', buildMidtermInputs);

function calculateGrade() {
  const count = parseInt(document.getElementById('g-midterm-count').value);
  const passGrade = parseFloat(document.getElementById('g-pass-grade').value);
  const finalPct = parseFloat(document.getElementById('g-final-pct').value);
  const courseName = document.getElementById('g-course-name').value || 'ƒ∞simsiz Ders';

  if (isNaN(passGrade) || isNaN(finalPct)) {
    showToast('L√ºtfen t√ºm alanlarƒ± doldurun!');
    return;
  }

  // Calculate total percentage to validate
  let totalPct = finalPct;
  let midtermContribution = 0;

  for (let i = 0; i < count; i++) {
    const grade = parseFloat(document.getElementById('g-mid-' + i).value);
    const pct = parseFloat(document.getElementById('g-mid-pct-' + i).value);

    if (isNaN(grade) || isNaN(pct)) {
      showToast('L√ºtfen t√ºm vize notlarƒ±nƒ± ve y√ºzdelerini girin!');
      return;
    }

    totalPct += pct;
    midtermContribution += grade * (pct / 100);
  }

  // Validate total is 100%
  if (Math.abs(totalPct - 100) > 0.5) {
    showToast(`Y√ºzdelerin toplamƒ± %100 olmalƒ±! ≈ûu an: %${totalPct}`);
    return;
  }

  // Formula: passGrade = midtermContribution + (finalGrade * finalPct/100)
  // finalGrade = (passGrade - midtermContribution) / (finalPct/100)
  const neededFinal = (passGrade - midtermContribution) / (finalPct / 100);
  const roundedNeed = Math.ceil(neededFinal * 100) / 100;

  // Minimum final grade requirement
  const finalMin = parseFloat(document.getElementById('g-final-min').value) || 0;
  const effectiveNeed = Math.max(roundedNeed, finalMin);

  let statusClass = '';
  let statusNote = '';

  if (roundedNeed > 100) {
    statusClass = 'danger';
    statusNote = '‚ùå Maalesef 100 alsan bile ge√ßemiyorsun. Dersin hocasƒ±yla konu≈ü veya b√ºt√ºnleme se√ßeneklerini ara≈ütƒ±r.';
  } else if (effectiveNeed <= 0) {
    statusClass = '';
    statusNote = 'üéâ Tebrikler! Final\'e girmesen bile ge√ßiyorsun! Ama yine de ders √ßalƒ±≈ümayƒ± bƒ±rakma.';
  } else if (roundedNeed < finalMin) {
    statusClass = '';
    statusNote = `‚úÖ Hesaba g√∂re ${roundedNeed.toFixed(1)} yeterli ama okulun finalden minimum <strong>${finalMin}</strong> alma ≈üartƒ± var. ${finalMin} hedefle!`;
  } else if (effectiveNeed <= 50) {
    statusClass = '';
    statusNote = '‚úÖ Gayet rahat bir durum. D√ºzenli √ßalƒ±≈üarak kolayca ge√ßebilirsin.';
  } else if (effectiveNeed <= 70) {
    statusClass = 'warning';
    statusNote = '‚ö†Ô∏è Biraz √ßaba gerekiyor. ƒ∞yi bir √ßalƒ±≈üma planƒ± ile ba≈üarabilirsin!';
  } else if (effectiveNeed <= 100) {
    statusClass = 'danger';
    statusNote = 'üî• Ciddi √ßalƒ±≈üma gerekiyor! Hemen √ßalƒ±≈ümaya ba≈üla.';
  }

  const displayNeed = effectiveNeed <= 0 ? 0 : Math.min(effectiveNeed, 100);

  // Show breakdown info
  let breakdownHtml = '';
  if (finalMin > 0 && roundedNeed < finalMin && roundedNeed <= 100) {
    breakdownHtml = `<div style="margin-top:12px;padding:12px 16px;background:rgba(255,255,255,0.6);border-radius:8px;font-size:13px;color:var(--text);">
      <strong>Detay:</strong> Ortalama i√ßin <strong>${roundedNeed.toFixed(1)}</strong> yeterliydi, ancak finalden minimum <strong>${finalMin}</strong> alma zorunluluƒüun var.
    </div>`;
  }

  document.getElementById('grade-result').innerHTML = `
    <div class="result-box ${statusClass}">
      <div class="result-label">Finalden Alman Gereken Minimum Not</div>
      <div class="result-value">${roundedNeed > 100 ? '100+' : displayNeed.toFixed(1)}</div>
      <div class="result-note">${statusNote}</div>
      ${breakdownHtml}
    </div>
  `;

  // Collect midterm details for history
  const midterms = [];
  for (let i = 0; i < count; i++) {
    midterms.push({
      grade: parseFloat(document.getElementById('g-mid-' + i).value),
      pct: parseFloat(document.getElementById('g-mid-pct-' + i).value)
    });
  }

  // Save calculation
  const calcs = loadData(STORAGE_KEYS.calcs);
  calcs.unshift({
    id: Date.now(),
    name: courseName,
    needed: roundedNeed > 100 ? 'ƒ∞mkansƒ±z' : displayNeed.toFixed(1),
    rawNeeded: roundedNeed > 100 ? 'ƒ∞mkansƒ±z' : roundedNeed.toFixed(1),
    status: statusClass || 'ok',
    date: new Date().toLocaleDateString('tr-TR'),
    midterms: midterms,
    finalPct: finalPct,
    finalMin: finalMin,
    passGrade: passGrade
  });
  if (calcs.length > 20) calcs.pop();
  saveData(STORAGE_KEYS.calcs, calcs);
  renderSavedCalcs();
}

function renderSavedCalcs() {
  const calcs = loadData(STORAGE_KEYS.calcs);
  const card = document.getElementById('saved-calcs-card');
  const list = document.getElementById('saved-calcs-list');

  if (calcs.length === 0) { card.style.display = 'none'; return; }

  card.style.display = 'block';
  list.innerHTML = calcs.map(c => {
    const color = c.status === 'danger' ? 'var(--danger)' : c.status === 'warning' ? 'var(--warning)' : 'var(--success)';

    // Build midterm detail tags
    let detailHtml = '';
    if (c.midterms && c.midterms.length > 0) {
      const midTags = c.midterms.map((m, i) => 
        `<span style="display:inline-block;background:var(--primary-pale);color:var(--primary);padding:3px 10px;border-radius:6px;font-size:12px;font-weight:600;">Vize ${i + 1}: ${m.grade} <span style="opacity:0.6;">(%${m.pct})</span></span>`
      ).join(' ');
      const finalTag = `<span style="display:inline-block;background:var(--accent-light);color:#9A7B30;padding:3px 10px;border-radius:6px;font-size:12px;font-weight:600;">Final: %${c.finalPct}</span>`;
      const passTag = `<span style="display:inline-block;background:#EDEDEB;color:var(--text-light);padding:3px 10px;border-radius:6px;font-size:12px;font-weight:600;">Ge√ßme: ${c.passGrade}</span>`;
      const minTag = c.finalMin ? `<span style="display:inline-block;background:var(--danger-light);color:var(--danger);padding:3px 10px;border-radius:6px;font-size:12px;font-weight:600;">Final Min: ${c.finalMin}</span>` : '';
      detailHtml = `<div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;">${midTags} ${finalTag} ${passTag} ${minTag}</div>`;
    }

    return `
      <div style="padding:16px 0; border-bottom:1px solid var(--border);">
        <div style="display:flex; align-items:center; justify-content:space-between;">
          <div>
            <strong style="color:var(--primary);font-size:16px;">${c.name}</strong>
            <span style="color:var(--text-light); font-size:13px; margin-left:8px;">${c.date}</span>
          </div>
          <div style="display:flex;align-items:center;gap:10px;">
            <div style="text-align:right;">
              <div style="font-size:11px;color:var(--text-light);text-transform:uppercase;letter-spacing:0.5px;font-weight:600;">Gereken Final</div>
              <div style="font-family:'DM Serif Display',serif; font-size:26px; color:${color}; line-height:1.1;">${c.needed}</div>
            </div>
            <button class="btn-icon" onclick="deleteCalc(${c.id})" title="Sil">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
            </button>
          </div>
        </div>
        ${detailHtml}
      </div>`;
  }).join('');
}

function deleteCalc(id) {
  let calcs = loadData(STORAGE_KEYS.calcs);
  calcs = calcs.filter(c => c.id !== id);
  saveData(STORAGE_KEYS.calcs, calcs);
  renderSavedCalcs();
  showToast('Hesaplama silindi');
}

// ============================
// ATTENDANCE TRACKER
// ============================
function openAddCourseModal() {
  document.getElementById('modal-add-course').classList.add('active');
  document.getElementById('m-course-name').focus();
}

function closeAddCourseModal() {
  document.getElementById('modal-add-course').classList.remove('active');
}

function addCourse() {
  const name = document.getElementById('m-course-name').value.trim();
  const totalWeeks = parseInt(document.getElementById('m-total-weeks').value) || 14;
  const maxAbsent = parseInt(document.getElementById('m-max-absent').value) || 3;
  const day = document.getElementById('m-course-day').value;
  const hour = document.getElementById('m-course-hour').value;
  const duration = parseFloat(document.getElementById('m-course-duration').value) || 2;

  if (!name) { showToast('Ders adƒ± giriniz!'); return; }

  const courses = loadData(STORAGE_KEYS.courses);
  courses.push({
    id: Date.now(),
    name,
    totalWeeks,
    maxAbsent,
    day,
    hour,
    duration,
    weeks: Array(totalWeeks).fill(null) // null = unmarked, true = present, false = absent
  });
  saveData(STORAGE_KEYS.courses, courses);

  document.getElementById('m-course-name').value = '';
  closeAddCourseModal();
  renderCourses();
  showToast(`"${name}" eklendi`);
}

function toggleWeek(courseId, weekIdx) {
  const courses = loadData(STORAGE_KEYS.courses);
  const course = courses.find(c => c.id === courseId);
  if (!course) return;

  // Handle legacy array format
  let val = course.weeks[weekIdx];
  if (Array.isArray(val)) val = val[0];

  // Cycle: null ‚Üí present ‚Üí absent ‚Üí null
  if (val === null) course.weeks[weekIdx] = true;
  else if (val === true) course.weeks[weekIdx] = false;
  else course.weeks[weekIdx] = null;

  saveData(STORAGE_KEYS.courses, courses);
  renderCourses();
}

function deleteCourse(courseId) {
  if (!confirm('Bu dersi silmek istediƒüinize emin misiniz?')) return;
  let courses = loadData(STORAGE_KEYS.courses);
  courses = courses.filter(c => c.id !== courseId);
  saveData(STORAGE_KEYS.courses, courses);
  renderCourses();
  showToast('Ders silindi');
}

function toggleCourseBody(courseId) {
  const body = document.getElementById('body-' + courseId);
  const chevron = document.getElementById('chev-' + courseId);
  body.classList.toggle('open');
  chevron.classList.toggle('open');
}

// Helper: count absences (handles legacy array format)
function countAbsent(course) {
  let count = 0;
  course.weeks.forEach(w => {
    const val = Array.isArray(w) ? w[0] : w;
    if (val === false) count++;
  });
  return count;
}

function countPresent(course) {
  let count = 0;
  course.weeks.forEach(w => {
    const val = Array.isArray(w) ? w[0] : w;
    if (val === true) count++;
  });
  return count;
}

function renderCourses() {
  const courses = loadData(STORAGE_KEYS.courses);
  const container = document.getElementById('courses-list');

  // Summary
  let totalAbsentAll = 0, riskCount = 0;
  courses.forEach(c => {
    const absent = countAbsent(c);
    totalAbsentAll += absent;
    if (absent >= c.maxAbsent) riskCount++;
  });
  document.getElementById('sum-total').textContent = courses.length;
  document.getElementById('sum-absent').textContent = totalAbsentAll;
  document.getElementById('sum-risk').textContent = riskCount;

  // Update calendar course list (always, even if empty)
  const calList = document.getElementById('calendar-course-list');
  if (calList) {
    const dayNamesShort = { MO: 'Pzt', TU: 'Sal', WE: '√áar', TH: 'Per', FR: 'Cum', SA: 'Cmt', SU: 'Paz' };
    calList.innerHTML = courses.length === 0
      ? '<p style="font-size:14px;color:var(--text-light);padding:8px 0;">Hen√ºz ders eklenmemi≈ü.</p>'
      : courses.map(c => {
        const absent = countAbsent(c);
        const remaining = Math.max(0, c.maxAbsent - absent);
        const dayLabel = c.day ? dayNamesShort[c.day] : '?';
        const hourLabel = c.hour || '?';
        return `<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);">
          <div>
            <strong style="color:var(--primary);">${c.name}</strong>
            <span style="color:var(--text-light);font-size:13px;margin-left:8px;">${dayLabel} ${hourLabel}</span>
            <span style="color:var(--text-light);font-size:13px;margin-left:4px;">‚Ä¢ ${remaining} hak kaldƒ±</span>
          </div>
          <button class="btn btn-sm btn-outline" onclick="exportCourseICS(${c.id})">üìÖ ƒ∞ndir</button>
        </div>`;
      }).join('');
  }

  if (courses.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:80px;height:80px;color:var(--border);margin-bottom:16px;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><line x1="8" y1="14" x2="8" y2="14.01"/><line x1="12" y1="14" x2="12" y2="14.01"/><line x1="16" y1="14" x2="16" y2="14.01"/></svg>
        <h3 style="font-family:'DM Serif Display',serif;font-size:20px;color:var(--text);margin-bottom:8px;">Hen√ºz ders eklenmemi≈ü</h3>
        <p>Devamsƒ±zlƒ±k takibi i√ßin yukarƒ±daki "Ders Ekle" butonuna tƒ±kla.</p>
      </div>`;
    return;
  }

  container.innerHTML = courses.map(course => {
    const absent = countAbsent(course);
    const present = countPresent(course);
    const remaining = course.maxAbsent - absent;
    const pct = course.totalWeeks > 0 ? Math.round((present / course.totalWeeks) * 100) : 0;

    let badgeClass = 'ok', badgeText = `${remaining} hak kaldƒ±`;
    if (remaining <= 0) { badgeClass = 'danger'; badgeText = 'Hak doldu!'; }
    else if (remaining === 1) { badgeClass = 'warn'; badgeText = '1 hak kaldƒ±!'; }

    const circumference = 2 * Math.PI * 18;
    const offset = circumference - (pct / 100) * circumference;
    const ringColor = remaining <= 0 ? 'var(--danger)' : remaining === 1 ? 'var(--warning)' : 'var(--success)';

    const weeksHtml = course.weeks.map((w, i) => {
      const val = Array.isArray(w) ? w[0] : w;
      let cls = '', icon = '‚Äî';
      if (val === true) { cls = 'present'; icon = '‚úì'; }
      else if (val === false) { cls = 'absent'; icon = '‚úó'; }
      return `<button class="week-btn ${cls}" onclick="toggleWeek(${course.id}, ${i})"><span>H${i + 1}</span><span>${icon}</span></button>`;
    }).join('');

    const dayNames = { MO: 'Pazartesi', TU: 'Salƒ±', WE: '√áar≈üamba', TH: 'Per≈üembe', FR: 'Cuma', SA: 'Cumartesi', SU: 'Pazar' };
    const dayLabel = course.day ? dayNames[course.day] : '';
    const hourLabel = course.hour || '';
    const dur = course.duration || 2;
    const durText = dur % 1 === 0 ? `${dur} saat` : `${Math.floor(dur)} saat 30 dk`;
    const scheduleText = dayLabel && hourLabel ? `${dayLabel} ${hourLabel} (${durText})` : '';

    return `
      <div class="course-card">
        <div class="course-header" onclick="toggleCourseBody(${course.id})">
          <div class="course-info">
            <h3>${course.name}</h3>
            <p>${scheduleText ? scheduleText + ' ‚Ä¢ ' : ''}${course.totalWeeks} hafta ‚Ä¢ ${present} giri≈ü ‚Ä¢ ${absent} devamsƒ±zlƒ±k</p>
          </div>
          <div class="course-stats">
            <span class="stat-badge ${badgeClass}">${badgeText}</span>
            <div class="progress-ring">
              <svg viewBox="0 0 48 48">
                <circle class="bg" cx="24" cy="24" r="18" fill="none" stroke-width="4"/>
                <circle class="fill" cx="24" cy="24" r="18" fill="none" stroke="${ringColor}" stroke-width="4" stroke-dasharray="${circumference}" stroke-dashoffset="${offset}" stroke-linecap="round"/>
              </svg>
              <div class="label" style="color:${ringColor}">%${pct}</div>
            </div>
            <button class="btn-icon" onclick="event.stopPropagation();exportCourseICS(${course.id})" title="Takvime Ekle" style="color:var(--accent);">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
            </button>
            <button class="btn-icon" onclick="event.stopPropagation();deleteCourse(${course.id})" title="Dersi Sil">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
            </button>
            <svg id="chev-${course.id}" class="chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
          </div>
        </div>
        <div class="course-body" id="body-${course.id}">
          <div class="course-body-inner">
            <p style="font-size:13px;color:var(--text-light);margin-bottom:8px;">Tƒ±kla: ‚úì Girdim ‚Üí ‚úó Girmedim ‚Üí ‚Äî ƒ∞≈üaretlenmemi≈ü</p>
            <div class="week-grid">${weeksHtml}</div>
          </div>
        </div>
      </div>`;
  }).join('');
}

// ============================
// GOOGLE CALENDAR .ICS EXPORT
// ============================
function generateCourseICSEvent(course) {
  const dayToDate = { SU: 0, MO: 1, TU: 2, WE: 3, TH: 4, FR: 5, SA: 6 };
  const pad = n => String(n).padStart(2, '0');

  const courseDay = course.day || 'MO';
  const courseHourRaw = course.hour || '09:00';
  const [startH, startM] = courseHourRaw.includes(':') ? courseHourRaw.split(':') : [courseHourRaw, '00'];
  const courseDuration = parseFloat(course.duration) || 2;
  const startMinutes = parseInt(startH) * 60 + parseInt(startM);
  const endMinutes = Math.min(startMinutes + courseDuration * 60, 23 * 60 + 59);
  const endH = pad(Math.floor(endMinutes / 60));
  const endM = pad(endMinutes % 60);

  const formatDateTime = (d, h, m) => `${d.getFullYear()}${pad(d.getMonth() + 1)}${pad(d.getDate())}T${h}${m}00`;
  const formatDateTimeStart = (d, h, m) => `${d.getFullYear()}${pad(d.getMonth() + 1)}${pad(d.getDate())}T${h}${m}00`;

  // Find next occurrence of the course day
  const now = new Date();
  const targetDay = dayToDate[courseDay];
  let daysUntil = targetDay - now.getDay();
  if (daysUntil <= 0) daysUntil += 7;
  const startDate = new Date(now.getTime() + daysUntil * 86400000);

  const absent = countAbsent(course);
  const remaining = Math.max(0, course.maxAbsent - absent);

  const summaryText = `üìö ${course.name} ‚Äî Yoklama Hatƒ±rlatma`;
  const descText = `Ders: ${course.name}\\nKalan devamsƒ±zlƒ±k hakkƒ±: ${remaining}/${course.maxAbsent}\\n\\nUniTracker uygulamanƒ± a√ßarak yoklamanƒ± i≈üaretle!`;
  const totalWeeks = course.totalWeeks || 14;

  return [
    'BEGIN:VEVENT',
    `UID:unitracker-${course.id}@unitracker`,
    `DTSTART:${formatDateTimeStart(startDate, startH, startM)}`,
    `DTEND:${formatDateTime(startDate, endH, endM)}`,
    `RRULE:FREQ=WEEKLY;COUNT=${totalWeeks};BYDAY=${courseDay}`,
    `SUMMARY:${summaryText}`,
    `DESCRIPTION:${descText}`,
    'BEGIN:VALARM',
    'TRIGGER:-PT30M',
    'ACTION:DISPLAY',
    `DESCRIPTION:${course.name} dersin 30 dakika sonra!`,
    'END:VALARM',
    'BEGIN:VALARM',
    'TRIGGER:-PT0M',
    'ACTION:DISPLAY',
    `DESCRIPTION:${course.name} dersin ba≈ülƒ±yor! Yoklamayƒ± unutma.`,
    'END:VALARM',
    'END:VEVENT'
  ].join('\r\n');
}

function downloadICS(content, filename) {
  const blob = new Blob([content], { type: 'text/calendar;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

function exportCourseICS(courseId) {
  const courses = loadData(STORAGE_KEYS.courses);
  const course = courses.find(c => c.id === courseId);
  if (!course) { showToast('Ders bulunamadƒ±!'); return; }

  const ics = [
    'BEGIN:VCALENDAR',
    'VERSION:2.0',
    'PRODID:-//UniTracker//TR',
    'CALSCALE:GREGORIAN',
    'METHOD:PUBLISH',
    generateCourseICSEvent(course),
    'END:VCALENDAR'
  ].join('\r\n');

  const safeName = course.name.replace(/[^a-zA-Z0-9ƒü√º≈üƒ±√∂√ßƒû√ú≈ûƒ∞√ñ√á]/g, '-').toLowerCase();
  downloadICS(ics, `unitracker-${safeName}.ics`);
  showToast(`üìÖ "${course.name}" takvim dosyasƒ± indirildi!`);
}

function exportAllCoursesICS() {
  const courses = loadData(STORAGE_KEYS.courses);
  if (courses.length === 0) { showToast('Hen√ºz ders eklenmemi≈ü!'); return; }

  const events = courses.map(c => generateCourseICSEvent(c)).join('\r\n');

  const ics = [
    'BEGIN:VCALENDAR',
    'VERSION:2.0',
    'PRODID:-//UniTracker//TR',
    'CALSCALE:GREGORIAN',
    'METHOD:PUBLISH',
    events,
    'END:VCALENDAR'
  ].join('\r\n');

  downloadICS(ics, 'unitracker-tum-dersler.ics');
  showToast(`üìÖ ${courses.length} ders takvime eklendi!`);
}

// ============================
// INIT
// ============================
document.addEventListener('DOMContentLoaded', () => {
  buildMidtermInputs();
  renderSavedCalcs();
  renderCourses();
});

// Close modal on overlay click
document.getElementById('modal-add-course').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeAddCourseModal();
});

// Keyboard shortcut for modal
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeAddCourseModal();
});
</script>
</body>
</html>
